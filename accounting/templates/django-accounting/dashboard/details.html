{% extends "django-accounting/includes/base.html" %}
{% load mptt_tags %}
{% load humanize %}

{% block title %}Dashboard | Details{% endblock %}

{% block contents %}
    <div class="p-6 space-y-8">
        <div class="bg-gray-300 dark:bg-stone-700 rounded-2xl shadow">
            <div class="p-4 border-b border-gray-200 dark:border-stone-600">
                <h2 class="text-lg font-medium dark:text-white">{{ tabel_heading }}</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-stone-600 text-sm">
                    <thead class="bg-gray-400 dark:bg-stone-800 uppercase tracking-wider">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-600 dark:text-gray-300">Particulars</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-600 dark:text-gray-300">Balance</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-stone-600">
                    {% recursetree accounts %}
                        <!-- Fixed Account Row with Expandable Transactions -->
                        <tr class="hover:bg-gray-50 dark:hover:bg-stone-600">
                            <td class="px-4 py-3 text-gray-700 dark:text-gray-200"
                                style="padding-left: {{ node.level|add:"1" }}rem;">
                                <div class="flex items-center gap-2">
                                    <!-- Expand/Collapse Button -->
                                    <button x-data="{ open: false }"
                                            @click="open = !open; $dispatch('toggle-transactions', { accountId: '{{ node.id }}', open: open })"
                                            class="p-1 rounded-md hover:bg-gray-200 dark:hover:bg-stone-500 transition focus:outline-none"
                                            :class="{ 'text-blue-600 dark:text-blue-400': open }">
                                        <svg class="w-4 h-4 transform transition-transform duration-200 ease-in-out"
                                             :class="{ 'rotate-90': open }"
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                    <!-- Account Name Link -->
                                    <a href="{% url 'accounting:account-details' node.slug %}"
                                       class="hover:text-blue-600 dark:hover:text-blue-400 transition">
                                        {{ node.name }}
                                    </a>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right font-medium text-gray-700 dark:text-gray-200">
                                {{ node.get_balance|intcomma|default:"0" }}
                            </td>
                        </tr>

                        <!-- Expandable Transactions Row -->
                        <tr x-data="{ open: false }"
                            @toggle-transactions.window="if ($event.detail.accountId === '{{ node.id }}') { open = $event.detail.open }"
                            x-show="open"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 transform -translate-y-2"
                            x-transition:enter-end="opacity-100 transform translate-y-0"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 transform translate-y-0"
                            x-transition:leave-end="opacity-0 transform -translate-y-2"
                            class="bg-gray-50 dark:bg-stone-700">
                            <td colspan="2" class="p-0">
                                <div class="bg-gray-200 dark:bg-stone-700 rounded-2xl shadow">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200 dark:divide-stone-600 text-sm">
                                            <thead class="bg-gray-400 dark:bg-stone-800 uppercase tracking-wider">
                                            <tr>
                                                <th class="px-4 py-3 text-left font-medium text-gray-900 dark:text-gray-300">
                                                    Date
                                                </th>
                                                <th class="px-4 py-3 text-left font-medium text-gray-900 dark:text-gray-300">
                                                    Particulars
                                                </th>
                                                <th class="px-4 py-3 text-left font-medium text-gray-900 dark:text-gray-300">
                                                    Description
                                                </th>
                                                <th class="px-4 py-3 text-right font-medium text-gray-900 dark:text-gray-300">
                                                    Amount
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-100 dark:divide-stone-600">
                                            {% for txn in recent_transactions %}
                                                <tr class="hover:bg-gray-50 dark:hover:bg-stone-600">
                                                    <td class="px-4 py-3 whitespace-nowrap text-gray-700 dark:text-gray-200">{{ txn.journal_entry.date }}</td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-gray-700 dark:text-gray-200">
                                                        <a href="{% url 'accounting:account-details' txn.account.slug %}">
                                                            {{ txn.account.name }}
                                                        </a>
                                                    </td>
                                                    <td class="px-4 py-3 text-gray-700 dark:text-gray-200">{{ txn.journal_entry.description }}</td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-right font-medium text-gray-800 dark:text-white">
                                                        {% if txn.debit %}
                                                            {{ txn.debit|intcomma }}
                                                        {% else %}
                                                            {{ txn.credit|intcomma }}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% empty %}
                                                <tr>
                                                    <td colspan="3"
                                                        class="px-4 py-6 text-center text-gray-500 dark:text-gray-400">
                                                        No recent
                                                        transactions.
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% if not node.is_leaf_node %}
                            {{ children }}
                        {% endif %}
                    {% endrecursetree %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}
